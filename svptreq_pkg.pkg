/* Formatted on 11/16/2015 10:09:04 AM (QP5 v5.277) */
/*
	<VERSION>1.0</VERSION>
	<FILENAME>svptreq_pkg.pkg</FILENAME>
	<AUTHOR>Georgian College</AUTHOR>
	<SUMMARY>The Off Count Report (the big one). </SUMMARY>
	 
	<OVERVIEW>
		First the data gets loaded into the "GWRFILE" table from the "sqlplus"     
		procedure that executes this package. 

		Then this procedure retrieves the data from the "GWRFILE" table and we    
		attempt to populate the "SVRTREQ", "SVRTNTE" and "SVRTDUP" tables.	

		Then we process the data from the "SVRTREQ" and "SVRTNTE" tables and if   
		no errors are encountered we generate a record in the "SHTTRAN" table  
		which will cause a transcript to be sent back to OCAS.
	</OVERVIEW>

	<DEPENDENCIES>
		
	</DEPENDENCIES>

	<EXCEPTIONS>
	</EXCEPTIONS>

	Modification History
	ID	Date        By		Modification
	--	----        --		------------
	<MODIFICATIONS>
	</MODIFICATIONS>
*/

CREATE OR REPLACE PACKAGE GEORGIAN.svptreq_pkg AS

 TYPE t_char_array IS TABLE OF VARCHAR2(100)  INDEX BY BINARY_INTEGER; 
 TYPE t_nmbr_array IS TABLE OF NUMBER INDEX BY BINARY_INTEGER;
  

 PROCEDURE process_requests
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_130_147_flg                   IN  VARCHAR2,
  p_reason_code                   IN  VARCHAR2,
  p_svptreq_job_no                IN  NUMBER);

 PROCEDURE get_stvsbgi_desc
 (p_stvsbgi_fice_desc             IN  OUT VARCHAR2);

 PROCEDURE get_svrtreq_info
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_completion_ind        OUT VARCHAR2);

 PROCEDURE insert_svrtreq_record
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_trans_date            IN  VARCHAR2,
  p_svrtreq_trans_time            IN  VARCHAR2,
  p_svrtreq_purpose_cde           IN  VARCHAR2,
  p_svrtreq_action_cde            IN  VARCHAR2,
  p_svrtreq_birth_date            IN  VARCHAR2,
  p_svrtreq_gender                IN  VARCHAR2,
  p_svrtreq_exit_date             IN  VARCHAR2,
  p_svrtreq_ocas_appnum           IN  VARCHAR2,
  p_svrtreq_sin                   IN  VARCHAR2,
  p_svrtreq_surname               IN  VARCHAR2,
  p_svrtreq_prefix                IN  VARCHAR2,
  p_svrtreq_firstname             IN  VARCHAR2,
  p_svrtreq_firstmidname          IN  VARCHAR2,
  p_svrtreq_secondmidname         IN  VARCHAR2,
  p_svrtreq_formersurname         IN  VARCHAR2,
  p_svrtreq_student_no_1          IN  VARCHAR2,
  p_svrtreq_student_no_2          IN  VARCHAR2,
  p_svrtreq_student_no_3          IN  VARCHAR2);

 PROCEDURE delete_svrtreq_record
 (p_svrtreq_bgn02                 IN  VARCHAR2);

 PROCEDURE insert_svrtnte_record
 (p_svrtnte_bgn02                 IN  VARCHAR2,
  p_svrtnte_note                  IN  VARCHAR2);

 PROCEDURE delete_svrtnte_record
 (p_svrtnte_bgn02                 IN  VARCHAR2);

 PROCEDURE match_student_info
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_birth_date            IN  DATE,
  p_svrtreq_sex                   IN  VARCHAR2,
  p_svrtreq_ssn                   IN  VARCHAR2,
  p_svrtreq_last_name             IN  VARCHAR2,
  p_svrtreq_first_name            IN  VARCHAR2,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_match_ind             OUT VARCHAR2,
  p_spriden_pidm                  OUT NUMBER,
  p_svrtreq_id                    OUT VARCHAR2);
  
PROCEDURE matchStudentInfo
(
	p_svrtreq_bgn02                 IN  svrtreq.svrtreq_bgn02%TYPE,
	p_svrtreq_birth_date            IN  svrtreq.svrtreq_birth_date%TYPE,
	p_svrtreq_sex                   IN  VARCHAR2,
	p_studentId                  	IN  spriden.spriden_id%TYPE,
	p_svrtreq_last_name             IN  svrtreq.svrtreq_surname%TYPE,
	p_svrtreq_first_name            IN  svrtreq.svrtreq_firstname%TYPE,
	p_svrtreq_state_ind             OUT VARCHAR2,
	p_svrtreq_match_ind             OUT VARCHAR2,
	p_spriden_pidm                  OUT NUMBER,
	p_svrtreq_id                    OUT VARCHAR2
);

 PROCEDURE insert_svrtdup_record
 (p_svrtdup_bgn02                 IN  VARCHAR2,
  p_svrtdup_pidm                  IN  NUMBER);

 PROCEDURE delete_svrtdup_record
 (p_svrtdup_bgn02                 IN  VARCHAR2);

 PROCEDURE get_spriden_pidm
 (p_spriden_id                    IN  VARCHAR2,
  p_spriden_pidm                  OUT NUMBER);

 PROCEDURE check_student_deceased
 (p_spbpers_pidm                  IN  NUMBER,
  p_spbpers_dead_ind              OUT VARCHAR2);

 PROCEDURE check_for_holds
 (p_spriden_pidm                  IN  NUMBER,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_hold_ind              OUT VARCHAR2);

 PROCEDURE determine_send_date
 (p_svrtreq_action_cde            IN  VARCHAR2,
  p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_send_date             OUT DATE,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_date_ind              OUT VARCHAR2,
  p_svrtreq_reason_cde            OUT VARCHAR2,
  p_error_message                 OUT VARCHAR2);

 PROCEDURE get_svrtnte_note
 (p_svrtnte_bgn02                 IN  VARCHAR2,
  p_record_type                   IN  VARCHAR2,
  p_svrtnte_note                  OUT VARCHAR2);

 PROCEDURE get_stvterm_end_date
 (p_stvterm_code                  IN  VARCHAR2,
  p_stvterm_end_date              OUT DATE);

 PROCEDURE insert_shttran_record
 (p_spriden_pidm                  IN  NUMBER,
  p_spriden_id                    IN  VARCHAR2,
  p_svrtreq_bgn02                 IN  VARCHAR2,
  p_shttran_seq_no                OUT NUMBER);

 PROCEDURE write_transcript_record
 (p_spriden_pidm                  IN  NUMBER,
  p_spriden_id                    IN  VARCHAR2,
  p_svrtreq_bgn02                 IN  VARCHAR2,
  p_shttran_seq_no                OUT NUMBER);

 PROCEDURE get_shttran_seq_no
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_id                    IN  VARCHAR2,
  p_shttran_pidm                  IN  NUMBER,
  p_shttran_seq_no                OUT NUMBER);

 PROCEDURE get_sgbstdn_term_code_eff
 (p_sgbstdn_pidm                  IN  NUMBER,
  p_current_term_code             IN  VARCHAR2,
  p_sgbstdn_term_code_eff         OUT VARCHAR2);

 PROCEDURE get_requestor_address
 (p_sobsbgi_sbgi_code             IN  VARCHAR2,
  p_sobsbgi_street_line1          OUT VARCHAR2,
  p_sobsbgi_street_line2          OUT VARCHAR2,
  p_sobsbgi_street_line3          OUT VARCHAR2,
  p_sobsbgi_city                  OUT VARCHAR2,
  p_sobsbgi_stat_code             OUT VARCHAR2,
  p_sobsbgi_zip                   OUT VARCHAR2,
  p_sobsbgi_natn_code             OUT VARCHAR2);

 PROCEDURE get_sfbetrm_term_code
 (p_sfbetrm_pidm                  IN  NUMBER,
  p_current_term_code             IN  VARCHAR2,
  p_sfbetrm_term_code             OUT VARCHAR2);

 PROCEDURE write_report_lines
 (p_report_detail_line            IN  VARCHAR2,
  p_report_page_no                IN  OUT NUMBER,
  p_report_line_cnt               IN  OUT NUMBER);

 PROCEDURE process_refusals
 (p_svptreq_job_no                IN  NUMBER);

 PROCEDURE insert_svptreq_record
 (p_svptreq_id                    IN  NUMBER,
  p_svptreq_seq_no                IN  OUT NUMBER,
  p_svptreq_147_data              IN  VARCHAR2);

 PROCEDURE get_gtvsdax_translation_code
 (p_gtvsdax_external_code         IN  VARCHAR2,
  p_gtvsdax_external_code_group   IN  VARCHAR2,
  p_gtvsdax_translation_code      OUT VARCHAR2);

 PROCEDURE get_spbpers_name_prefix
 (p_spbpers_pidm                  IN  NUMBER,
  p_spbpers_name_prefix           OUT VARCHAR2);

 PROCEDURE update_svrtreq_record
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_send_date             IN  DATE,
  p_svrtreq_state_ind             IN  VARCHAR2,
  p_svrtreq_match_ind             IN  VARCHAR2,
  p_svrtreq_hold_ind              IN  VARCHAR2,
  p_svrtreq_date_ind              IN  VARCHAR2,
  p_svrtreq_completion_ind        IN  VARCHAR2,
  p_svrtreq_id                    IN  VARCHAR2,
  p_svrtreq_seq_no                IN  NUMBER,
  p_svrtreq_reason_cde            IN  VARCHAR2);

END svptreq_pkg;
/
SHOW ERRORS



CREATE OR REPLACE PACKAGE BODY GEORGIAN.svptreq_pkg AS

 PROCEDURE process_requests
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_130_147_flg                   IN  VARCHAR2,
  p_reason_code                   IN  VARCHAR2,
  p_svptreq_job_no                IN  NUMBER) IS

 v_gwrfile_line                   gwrfile.gwrfile_line%TYPE;
 v_gwrfile_data                   gwrfile.gwrfile_data%TYPE;

 v_rcrd_err_flg                   NUMBER;
 v_rcrd_len                       NUMBER;
 v_rcrd_fld_cntr                  NUMBER;
 v_rcrd_comma_pos                 NUMBER;
 v_rcrd_tmp_fld                   VARCHAR2(200);

 v_rpt_detl_line                  VARCHAR2(132);
 v_rpt_page_no                    NUMBER;
 v_rpt_line_cnt                   NUMBER;
 v_rpt_message                    VARCHAR2(50);

 v_treq_purpose                   VARCHAR2(2);
 v_treq_bgn_nmbr                  VARCHAR2(30);
 v_treq_trn_date                  VARCHAR2(8);
 v_treq_trn_time                  VARCHAR2(8);
 v_treq_actncode                  VARCHAR2(2);
 v_treq_dob_date                  VARCHAR2(8);
 v_treq_gender                    VARCHAR2(1);
 v_treq_exitdate                  VARCHAR2(8);
 v_treq_ocasnmbr                  VARCHAR2(30);
 v_treq_sin_nmbr                  VARCHAR2(9);
 v_treq_stdntid1                  VARCHAR2(30);
 v_treq_stdntid2                  VARCHAR2(30);
 v_treq_stdntid3                  VARCHAR2(30);

 v_tnte_note                      VARCHAR2(200);

 t_tnte_note                      t_char_array;
 t_tnte_idx                       BINARY_INTEGER;
 t_tnte_cnt                       BINARY_INTEGER;

 v_tidn_type                      VARCHAR2(2);
 v_tidn_name                      VARCHAR2(60);
 v_tidn_prefix                    VARCHAR2(60);
 v_tidn_1st_name                  VARCHAR2(60);
 v_tidn_1st_midl                  VARCHAR2(60);
 v_tidn_2nd_midl                  VARCHAR2(60);
 v_tidn_surname                   VARCHAR2(60);
 v_tidn_former                    VARCHAR2(60);

 v_svrtreq_bgn02                  svrtreq.svrtreq_bgn02%TYPE;
 v_svrtreq_trans_date             svrtreq.svrtreq_trans_date%TYPE;
 v_svrtreq_purpose_cde            svrtreq.svrtreq_purpose_cde%TYPE;
 v_svrtreq_action_cde             svrtreq.svrtreq_action_cde%TYPE;
 v_svrtreq_birth_date             svrtreq.svrtreq_birth_date%TYPE;
 v_svrtreq_gender                 svrtreq.svrtreq_gender%TYPE;
 v_svrtreq_sin                    svrtreq.svrtreq_sin%TYPE;
 v_svrtreq_surname                svrtreq.svrtreq_surname%TYPE;
 v_svrtreq_firstname              svrtreq.svrtreq_firstname%TYPE;
 v_svrtreq_send_date              svrtreq.svrtreq_send_date%TYPE;
 v_svrtreq_state_ind              svrtreq.svrtreq_state_ind%TYPE;
 v_svrtreq_match_ind              svrtreq.svrtreq_match_ind%TYPE;
 v_svrtreq_hold_ind               svrtreq.svrtreq_hold_ind%TYPE;
 v_svrtreq_date_ind               svrtreq.svrtreq_date_ind%TYPE;
 v_svrtreq_completion_ind         svrtreq.svrtreq_completion_ind%TYPE;
 v_svrtreq_id                     svrtreq.svrtreq_id%TYPE;

 v_spriden_pidm                   spriden.spriden_id%TYPE;

 v_spbpers_dead_ind               spbpers.spbpers_dead_ind%TYPE;

 v_svrtreq_reason_cde             svrtreq.svrtreq_reason_cde%TYPE;

 v_shttran_seq_no                 shttran.shttran_seq_no%TYPE;

 CURSOR c1 IS
  SELECT gwrfile_line,
         gwrfile_data
    FROM gwrfile
   WHERE gwrfile_sequence        =  p_svptreq_job_no
     AND LOWER(gwrfile_jobname)  = 'svptreq'
     AND LOWER(gwrfile_filename) LIKE '%fl146%'
   ORDER BY 1;

 CURSOR c2 IS
  SELECT svrtreq_bgn02,
         svrtreq_trans_date,
         svrtreq_purpose_cde,
         svrtreq_action_cde,
         svrtreq_birth_date,
         svrtreq_gender,
         svrtreq_sin,
         svrtreq_surname,
         svrtreq_firstname,
         svrtreq_send_date,
         svrtreq_state_ind,
         svrtreq_match_ind,
         svrtreq_hold_ind,
         svrtreq_date_ind,
         svrtreq_completion_ind,
         svrtreq_id
    FROM svrtreq
   WHERE svrtreq_state_ind  != 'X'
     AND svrtreq_completion_ind NOT IN ('130','147')
     AND svrtreq_reason_cde IS NULL
     FOR UPDATE OF svrtreq_state_ind;

 BEGIN

  v_rcrd_err_flg := 0;
  v_rpt_page_no  := 0;
  v_rpt_line_cnt := 99;
  v_treq_purpose := NULL;

  OPEN c1;
  LOOP  
	log_details('process_requests',0,'','beginning of process',p_svrtreq_bgn02 || ' ' || p_130_147_flg || ' ' ||  p_reason_code);

   FETCH c1
    INTO v_gwrfile_line,
         v_gwrfile_data;

   EXIT WHEN c1%NOTFOUND;

   v_rcrd_len      := LENGTH(v_gwrfile_data);
   v_rcrd_fld_cntr := 1;

   IF  UPPER(SUBSTR(v_gwrfile_data,1,4)) = 'TREQ'
   THEN
       IF  v_treq_purpose IS NOT NULL
       THEN
           IF  v_rcrd_err_flg = 1
           THEN
               v_rpt_detl_line
                := SUBSTR(RPAD(SUBSTR(v_treq_bgn_nmbr,1,15),16,' ')||
                   RPAD(v_treq_trn_date,12,' ')||
                   RPAD(v_treq_purpose,7,  ' ')||
                   RPAD(v_treq_actncode,5, ' ')||
                   RPAD(SUBSTR(NVL(v_tidn_1st_name,' '),1,15),16,' ')||
                   RPAD(SUBSTR(NVL(v_tidn_surname, ' '),1,15),16,' ')||
                   RPAD(v_treq_dob_date,9, ' ')||
                   RPAD(v_treq_sin_nmbr,10,' ')||
                   v_rpt_message,1,132);

               write_report_lines
               (v_rpt_detl_line,
                v_rpt_page_no,
                v_rpt_line_cnt);
           ELSIF  v_treq_purpose != '01'
              THEN
                  insert_svrtreq_record
                  (v_treq_bgn_nmbr,
                   v_treq_trn_date,
                   v_treq_trn_time,
                   v_treq_purpose,
                   v_treq_actncode,
                   v_treq_dob_date,
                   v_treq_gender,
                   v_treq_exitdate,
                   v_treq_ocasnmbr,
                   v_treq_sin_nmbr,
                   v_tidn_surname,
                   v_tidn_prefix,
                   v_tidn_1st_name,
                   v_tidn_1st_midl,
                   v_tidn_2nd_midl,
                   v_tidn_former,
                   v_treq_stdntid1,
                   v_treq_stdntid2,
                   v_treq_stdntid3);

                  t_tnte_idx := 1;

                  WHILE (t_tnte_idx <= t_tnte_cnt)
                   LOOP

                    insert_svrtnte_record
                    (v_treq_bgn_nmbr,
                     t_tnte_note(t_tnte_idx));

                    t_tnte_idx := t_tnte_idx + 1;

                   END LOOP;
           END IF;
       END IF;

       v_rcrd_err_flg  := 0;
       v_treq_purpose  := NULL;
       v_treq_bgn_nmbr := NULL;
       v_treq_trn_date := NULL;
       v_treq_trn_time := NULL;
       v_treq_actncode := NULL;
       v_treq_dob_date := NULL;
       v_treq_gender   := NULL;
       v_treq_exitdate := NULL;
       v_treq_ocasnmbr := NULL;
       v_treq_sin_nmbr := NULL;
       v_treq_stdntid1 := NULL;
       v_treq_stdntid2 := NULL;
       v_treq_stdntid3 := NULL;
       v_tnte_note     := NULL;
       t_tnte_cnt      := 0;
       v_tidn_prefix   := NULL;
       v_tidn_1st_name := NULL;
       v_tidn_1st_midl := NULL;
       v_tidn_2nd_midl := NULL;
       v_tidn_surname  := NULL;
       v_tidn_former   := NULL;

       WHILE (v_rcrd_fld_cntr <= 18)
        LOOP

         v_rcrd_comma_pos := INSTR(v_gwrfile_data, '|');

         IF  v_rcrd_comma_pos = 0
         THEN
             v_rcrd_tmp_fld := LTRIM(RTRIM(v_gwrfile_data));

             IF  v_rcrd_tmp_fld IS NOT NULL
             THEN
                 CASE v_rcrd_fld_cntr

                  WHEN 5
                  THEN v_treq_purpose  := RTRIM(v_rcrd_tmp_fld);
                  WHEN 6
                  THEN v_treq_bgn_nmbr := RTRIM(v_rcrd_tmp_fld);
                  WHEN 7
                  THEN v_treq_trn_date := RTRIM(v_rcrd_tmp_fld);
                  WHEN 8
                  THEN v_treq_trn_time := RTRIM(v_rcrd_tmp_fld);
                  WHEN 10
                  THEN v_treq_actncode := RTRIM(v_rcrd_tmp_fld);
                  WHEN 11
                  THEN v_treq_dob_date := RTRIM(v_rcrd_tmp_fld);
                  WHEN 12
                  THEN v_treq_gender   := RTRIM(v_rcrd_tmp_fld);
                  WHEN 13
                  THEN v_treq_exitdate := RTRIM(v_rcrd_tmp_fld);
                  WHEN 14
                  THEN v_treq_ocasnmbr := RTRIM(v_rcrd_tmp_fld);
                  WHEN 15
                  THEN v_treq_sin_nmbr := RTRIM(v_rcrd_tmp_fld);
                  WHEN 16
                  THEN v_treq_stdntid1 := RTRIM(v_rcrd_tmp_fld);
                  WHEN 17
                  THEN v_treq_stdntid2 := RTRIM(v_rcrd_tmp_fld);
                  WHEN 18
                  THEN v_treq_stdntid3 := RTRIM(v_rcrd_tmp_fld);

                  ELSE NULL;

                 END CASE;

                 v_rcrd_fld_cntr := 25;
             END IF;
         ELSE
             v_rcrd_tmp_fld := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, 1, v_rcrd_comma_pos - 1)));

             CASE v_rcrd_fld_cntr

              WHEN 5
              THEN v_treq_purpose  := RTRIM(v_rcrd_tmp_fld);
              WHEN 6
              THEN v_treq_bgn_nmbr := RTRIM(v_rcrd_tmp_fld);
              WHEN 7
              THEN v_treq_trn_date := RTRIM(v_rcrd_tmp_fld);
              WHEN 8
              THEN v_treq_trn_time := RTRIM(v_rcrd_tmp_fld);
              WHEN 10
              THEN v_treq_actncode := RTRIM(v_rcrd_tmp_fld);
              WHEN 11
              THEN v_treq_dob_date := RTRIM(v_rcrd_tmp_fld);
              WHEN 12
              THEN v_treq_gender   := RTRIM(v_rcrd_tmp_fld);
              WHEN 13
              THEN v_treq_exitdate := RTRIM(v_rcrd_tmp_fld);
              WHEN 14
              THEN v_treq_ocasnmbr := RTRIM(v_rcrd_tmp_fld);
              WHEN 15
              THEN v_treq_sin_nmbr := RTRIM(v_rcrd_tmp_fld);
              WHEN 16
              THEN v_treq_stdntid1 := RTRIM(v_rcrd_tmp_fld);
              WHEN 17
              THEN v_treq_stdntid2 := RTRIM(v_rcrd_tmp_fld);
              WHEN 18
              THEN v_treq_stdntid3 := RTRIM(v_rcrd_tmp_fld);

              ELSE NULL;

             END CASE;

             v_rcrd_fld_cntr := v_rcrd_fld_cntr + 1;
             v_gwrfile_data  := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, v_rcrd_comma_pos + 1, v_rcrd_len - v_rcrd_comma_pos)));
             v_rcrd_len      := LENGTH(v_gwrfile_data);
         END IF;

        END LOOP;

       get_svrtreq_info
       (v_treq_bgn_nmbr,
        v_svrtreq_state_ind,
        v_svrtreq_completion_ind);

       IF  v_treq_purpose = '01'
       THEN
           IF  v_svrtreq_state_ind = 'C'
           THEN
               v_rcrd_err_flg :=  1;
               v_rpt_message  := 'cannot cancel request already processed';
           ELSIF  v_svrtreq_state_ind = 'X'
              THEN
                  v_rcrd_err_flg :=  1;
                  v_rpt_message  := 'cannot cancel request already cancelled';
              ELSIF  v_svrtreq_state_ind IS NULL
                 THEN
                     v_rcrd_err_flg :=  1;
                     v_rpt_message  := 'cannot cancel request does not exist';
                 ELSE
                     update_svrtreq_record
                     (v_treq_bgn_nmbr,
                      NULL,
                     'X',
                      NULL,
                      NULL,
                      NULL,
                      NULL,
                      NULL,
                      NULL,
                      NULL);
           END IF;
       ELSIF  v_treq_purpose = '13'
          THEN
              IF  v_svrtreq_state_ind IS NOT NULL
              THEN
                  v_rcrd_err_flg :=  1;
                  v_rpt_message  := 'cannot create request already exists';
              END IF;
          ELSIF  v_treq_purpose = '15'
             THEN
                 IF  v_svrtreq_completion_ind = '130'
                 THEN
                     v_rcrd_err_flg :=  1;
                     v_rpt_message  := 'cannot re-submit request already processed';
                 ELSIF  v_svrtreq_state_ind IS NOT NULL
                    THEN
                        delete_svrtdup_record
                        (v_treq_bgn_nmbr);
                        delete_svrtnte_record
                        (v_treq_bgn_nmbr);
                        delete_svrtreq_record
                        (v_treq_bgn_nmbr);
                 END IF;
       END IF;
   END IF;

   IF  UPPER(SUBSTR(v_gwrfile_data,1,4)) = 'TNTE'
   AND v_treq_purpose != '01'
   AND v_rcrd_err_flg  =  0
   THEN
       v_tnte_note := NULL;

       WHILE (v_rcrd_fld_cntr <= 5)
        LOOP

         v_rcrd_comma_pos := INSTR(v_gwrfile_data, '|');

         IF  v_rcrd_comma_pos = 0
         THEN
             v_rcrd_tmp_fld := LTRIM(RTRIM(v_gwrfile_data));

             IF  v_rcrd_tmp_fld IS NOT NULL
             THEN
                 CASE v_rcrd_fld_cntr

                  WHEN 5
                  THEN v_tnte_note := RTRIM(v_rcrd_tmp_fld);

                  ELSE NULL;

                 END CASE;

                 v_rcrd_fld_cntr := 25;
             END IF;
         ELSE
             v_rcrd_tmp_fld := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, 1, v_rcrd_comma_pos - 1)));

             CASE v_rcrd_fld_cntr

              WHEN 5
              THEN v_tnte_note := RTRIM(v_rcrd_tmp_fld);

              ELSE NULL;

             END CASE;

             v_rcrd_fld_cntr := v_rcrd_fld_cntr + 1;
             v_gwrfile_data  := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, v_rcrd_comma_pos + 1, v_rcrd_len - v_rcrd_comma_pos)));
             v_rcrd_len      := LENGTH(v_gwrfile_data);
         END IF;

        END LOOP;

       IF  v_tnte_note LIKE 'INSTITUTION%'
       THEN
           v_tnte_note     := RTRIM(LTRIM(LTRIM(v_tnte_note,'INSTITUTION')));
           v_gwrfile_data  := v_tnte_note;
           v_rcrd_len      := LENGTH(v_gwrfile_data);
           v_rcrd_fld_cntr := 1;

           WHILE (v_rcrd_fld_cntr <= 10)
            LOOP

             v_rcrd_comma_pos := INSTR(v_gwrfile_data, ':');

             IF  v_rcrd_comma_pos = 0
             THEN
                 v_rcrd_tmp_fld := LTRIM(RTRIM(v_gwrfile_data));

                 IF  v_rcrd_tmp_fld IS NOT NULL
                 THEN
                     t_tnte_cnt              := t_tnte_cnt + 1;
                     t_tnte_note(t_tnte_cnt) := v_rcrd_tmp_fld;
                     v_rcrd_fld_cntr         := 25;
                 END IF;
             ELSE
                 v_rcrd_tmp_fld          := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, 1, v_rcrd_comma_pos - 1)));
                 t_tnte_cnt              := t_tnte_cnt + 1;
                 t_tnte_note(t_tnte_cnt) := v_rcrd_tmp_fld;
                 v_rcrd_fld_cntr         := v_rcrd_fld_cntr + 1;
                 v_gwrfile_data          := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, v_rcrd_comma_pos + 1, v_rcrd_len - v_rcrd_comma_pos)));
                 v_rcrd_len              := LENGTH(v_gwrfile_data);
             END IF;

             get_stvsbgi_desc
             (t_tnte_note(t_tnte_cnt));

            END LOOP;
       ELSE
           t_tnte_cnt              := t_tnte_cnt + 1;
           t_tnte_note(t_tnte_cnt) := REPLACE(RTRIM(LTRIM(v_tnte_note)),' ','');
       END IF;
   END IF;

   IF  UPPER(SUBSTR(v_gwrfile_data,1,4)) = 'TIDN'
   AND v_treq_purpose != '01'
   THEN
       v_tidn_type := NULL;
       v_tidn_name := NULL;

       WHILE (v_rcrd_fld_cntr <= 6)
        LOOP

         v_rcrd_comma_pos := INSTR(v_gwrfile_data, '|');

         IF  v_rcrd_comma_pos = 0
         THEN
             v_rcrd_tmp_fld := LTRIM(RTRIM(v_gwrfile_data));

             IF  v_rcrd_tmp_fld IS NOT NULL
             THEN
                 CASE v_rcrd_fld_cntr

                  WHEN 5
                  THEN v_tidn_type := RTRIM(v_rcrd_tmp_fld);
                  WHEN 6
                  THEN v_tidn_name := RTRIM(v_rcrd_tmp_fld);

                  ELSE NULL;

                 END CASE;

                 v_rcrd_fld_cntr := 25;
             END IF;
         ELSE
             v_rcrd_tmp_fld := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, 1, v_rcrd_comma_pos - 1)));

             CASE v_rcrd_fld_cntr

              WHEN 5
              THEN v_tidn_type := RTRIM(v_rcrd_tmp_fld);
              WHEN 6
              THEN v_tidn_name := RTRIM(v_rcrd_tmp_fld);

              ELSE NULL;

             END CASE;

             v_rcrd_fld_cntr := v_rcrd_fld_cntr + 1;
             v_gwrfile_data  := LTRIM(RTRIM(SUBSTR(v_gwrfile_data, v_rcrd_comma_pos + 1, v_rcrd_len - v_rcrd_comma_pos)));
             v_rcrd_len      := LENGTH(v_gwrfile_data);
         END IF;

        END LOOP;

       CASE v_tidn_type

        WHEN '01'
        THEN  v_tidn_prefix   := v_tidn_name;
        WHEN '02'
        THEN  v_tidn_1st_name := v_tidn_name;
        WHEN '03'
        THEN  v_tidn_1st_midl := v_tidn_name;
        WHEN '04'
        THEN  v_tidn_2nd_midl := v_tidn_name;
        WHEN '05'
        THEN  v_tidn_surname  := v_tidn_name;
        WHEN '15'
        THEN  v_tidn_former   := v_tidn_name;

        ELSE  NULL;

       END CASE;
   END IF;

  END LOOP;
  CLOSE c1;

  IF  v_treq_purpose IS NOT NULL
  THEN
      IF  v_rcrd_err_flg = 1
      THEN
          v_rpt_detl_line
           := SUBSTR(RPAD(SUBSTR(v_treq_bgn_nmbr,1,15),16,' ')||
              RPAD(v_treq_trn_date,12,' ')||
              RPAD(v_treq_purpose,7,  ' ')||
              RPAD(v_treq_actncode,5, ' ')||
              RPAD(SUBSTR(NVL(v_tidn_1st_name,' '),1,15),16,' ')||
              RPAD(SUBSTR(NVL(v_tidn_surname, ' '),1,15),16,' ')||
              RPAD(v_treq_dob_date,9, ' ')||
              RPAD(v_treq_sin_nmbr,10,' ')||
              v_rpt_message,1,132);

          write_report_lines
          (v_rpt_detl_line,
           v_rpt_page_no,
           v_rpt_line_cnt);
      ELSE
          insert_svrtreq_record
          (v_treq_bgn_nmbr,
           v_treq_trn_date,
           v_treq_trn_time,
           v_treq_purpose,
           v_treq_actncode,
           v_treq_dob_date,
           v_treq_gender,
           v_treq_exitdate,
           v_treq_ocasnmbr,
           v_treq_sin_nmbr,
           v_tidn_surname,
           v_tidn_prefix,
           v_tidn_1st_name,
           v_tidn_1st_midl,
           v_tidn_2nd_midl,
           v_tidn_former,
           v_treq_stdntid1,
           v_treq_stdntid2,
           v_treq_stdntid3);

          t_tnte_idx := 1;

          WHILE (t_tnte_idx <= t_tnte_cnt)
           LOOP

            insert_svrtnte_record
            (v_treq_bgn_nmbr,
             t_tnte_note(t_tnte_idx));

            t_tnte_idx := t_tnte_idx + 1;

           END LOOP;
      END IF;
  END IF;

  COMMIT;

  log_details('process_requests',0,'','c2 cursor',p_svrtreq_bgn02 || ' ' || p_130_147_flg || ' ' ||  p_reason_code);

  OPEN c2;
  LOOP

   FETCH c2
    INTO v_svrtreq_bgn02,
         v_svrtreq_trans_date,
         v_svrtreq_purpose_cde,
         v_svrtreq_action_cde,
         v_svrtreq_birth_date,
         v_svrtreq_gender,
         v_svrtreq_sin,
         v_svrtreq_surname,
         v_svrtreq_firstname,
         v_svrtreq_send_date,
         v_svrtreq_state_ind,
         v_svrtreq_match_ind,
         v_svrtreq_hold_ind,
         v_svrtreq_date_ind,
         v_svrtreq_completion_ind,
         v_svrtreq_id;

   EXIT WHEN c2%NOTFOUND;
	log_details('process_requests',0,'','c2 cursor - we have data',v_svrtreq_bgn02 || ' ' || v_svrtreq_surname);
   v_rcrd_err_flg       := 0;
   v_spriden_pidm       := NULL;
   v_svrtreq_reason_cde := NULL;
   v_rpt_message        := NULL;

   IF  v_svrtreq_state_ind IN ('P','M')
   THEN
       delete_svrtdup_record
       (v_svrtreq_bgn02);

       IF  v_svrtreq_id IS NULL
       THEN
           match_student_info
           (v_svrtreq_bgn02,
            v_svrtreq_birth_date,
            v_svrtreq_gender,
            v_svrtreq_sin,
            v_svrtreq_surname,
            v_svrtreq_firstname,
            v_svrtreq_state_ind,
            v_svrtreq_match_ind,
            v_spriden_pidm,
            v_svrtreq_id);
       ELSE
           v_svrtreq_state_ind := 'H';
           v_svrtreq_match_ind := 'X';
       END IF;

       IF  v_svrtreq_state_ind = 'H'
       THEN
           IF  v_spriden_pidm IS NULL
           THEN
               get_spriden_pidm
               (v_svrtreq_id,
                v_spriden_pidm);
           END IF;

           check_student_deceased
           (v_spriden_pidm,
            v_spbpers_dead_ind);

           IF  NVL(v_spbpers_dead_ind,'n') = 'Y'
           THEN
               v_svrtreq_send_date  :=  TRUNC(SYSDATE);
               v_svrtreq_state_ind  := 'C';
               v_svrtreq_hold_ind   := 'N';
               v_svrtreq_reason_cde := '12';
           END IF;
       END IF;
   END IF;

   IF  v_svrtreq_state_ind = 'H'
   THEN
       IF  NVL(v_svrtreq_hold_ind,'~') = 'O'
       THEN
           v_svrtreq_state_ind := 'D';
       ELSE
           IF  v_spriden_pidm IS NULL
           THEN
               get_spriden_pidm
               (v_svrtreq_id,
                v_spriden_pidm);
           END IF;

           check_for_holds
           (v_spriden_pidm,
            v_svrtreq_state_ind,
            v_svrtreq_hold_ind);
       END IF;
   END IF;

   IF  v_svrtreq_state_ind = 'D'
   THEN
       determine_send_date
       (v_svrtreq_action_cde,
        v_svrtreq_bgn02,
        v_svrtreq_send_date,
        v_svrtreq_state_ind,
        v_svrtreq_date_ind,
        v_svrtreq_reason_cde,
        v_rpt_message);
   END IF;

   IF  v_rpt_message IS NULL
   THEN
       v_shttran_seq_no := NULL;

       IF  v_svrtreq_state_ind = 'C'
       AND v_svrtreq_send_date  IS NOT NULL
       AND TRUNC(v_svrtreq_send_date) <= TRUNC(SYSDATE)
       AND v_svrtreq_reason_cde IS NULL
       THEN
           IF  v_spriden_pidm IS NULL
           THEN
               get_spriden_pidm
               (v_svrtreq_id,
                v_spriden_pidm);
           END IF;

           insert_shttran_record
           (v_spriden_pidm,
            v_svrtreq_id,
            v_svrtreq_bgn02,
            v_shttran_seq_no);
           v_svrtreq_completion_ind := '130';
       END IF;

       update_svrtreq_record
       (v_svrtreq_bgn02,
        v_svrtreq_send_date,
        v_svrtreq_state_ind,
        v_svrtreq_match_ind,
        v_svrtreq_hold_ind,
        v_svrtreq_date_ind,
        v_svrtreq_completion_ind,
        v_svrtreq_id,
        v_shttran_seq_no,
        v_svrtreq_reason_cde);
   ELSE
       v_rpt_detl_line
        := SUBSTR(RPAD(SUBSTR(v_svrtreq_bgn02,1,15),16,' ')||
           RPAD(TO_CHAR(v_svrtreq_trans_date,'yyyymmdd'),12,' ')||
           RPAD(v_svrtreq_purpose_cde,7,  ' ')||
           RPAD(v_svrtreq_action_cde,5, ' ')||
           RPAD(SUBSTR(v_svrtreq_firstname,1,15),16,' ')||
           RPAD(SUBSTR(v_svrtreq_surname, 1,15),16,' ')||
           RPAD(TO_CHAR(v_svrtreq_birth_date,'yyyymmdd'),9, ' ')||
           RPAD(v_svrtreq_sin,10,' ')||
           v_rpt_message,1,132);

       write_report_lines
       (v_rpt_detl_line,
        v_rpt_page_no,
        v_rpt_line_cnt);

       delete_svrtdup_record
       (v_svrtreq_bgn02);

       delete_svrtnte_record
       (v_svrtreq_bgn02);

       delete_svrtreq_record
       (v_svrtreq_bgn02);
   END IF;

  END LOOP;
  CLOSE c2;

  COMMIT;

 END process_requests;

/*----------------------------------------------------------------------------*/
/* Get the institution description from the "STVSBGI" table.                  */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_stvsbgi_desc
 (p_stvsbgi_fice_desc             IN  OUT VARCHAR2) IS

 v_stvsbgi_desc                   stvsbgi.stvsbgi_desc%TYPE;

 CURSOR c3 IS
  SELECT stvsbgi_desc
    FROM stvsbgi
   WHERE stvsbgi_fice = p_stvsbgi_fice_desc;

 BEGIN

  v_stvsbgi_desc := NULL;

  OPEN c3;
  FETCH c3
   INTO v_stvsbgi_desc;
  CLOSE c3;

  IF  v_stvsbgi_desc IS NULL
  THEN
      v_stvsbgi_desc  := 'UNKNOWN?';
  END IF;

  p_stvsbgi_fice_desc := 'inst='||p_stvsbgi_fice_desc||'/'||v_stvsbgi_desc;

 END get_stvsbgi_desc;

/*----------------------------------------------------------------------------*/
/* Get information from an existing "SVRTREQ" record.                         */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_svrtreq_info
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_completion_ind        OUT VARCHAR2) IS

 CURSOR c4 IS
  SELECT svrtreq_state_ind,
         svrtreq_completion_ind
    FROM svrtreq
   WHERE svrtreq_bgn02 = p_svrtreq_bgn02;

 BEGIN

  p_svrtreq_state_ind      := NULL;
  p_svrtreq_completion_ind := NULL;

  OPEN c4;
  FETCH c4
   INTO p_svrtreq_state_ind,
        p_svrtreq_completion_ind;
  CLOSE c4;

 END get_svrtreq_info;

/*----------------------------------------------------------------------------*/
/* Insert a record into the "SVRTREQ" table.                                  */
/*----------------------------------------------------------------------------*/

 PROCEDURE insert_svrtreq_record
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_trans_date            IN  VARCHAR2,
  p_svrtreq_trans_time            IN  VARCHAR2,
  p_svrtreq_purpose_cde           IN  VARCHAR2,
  p_svrtreq_action_cde            IN  VARCHAR2,
  p_svrtreq_birth_date            IN  VARCHAR2,
  p_svrtreq_gender                IN  VARCHAR2,
  p_svrtreq_exit_date             IN  VARCHAR2,
  p_svrtreq_ocas_appnum           IN  VARCHAR2,
  p_svrtreq_sin                   IN  VARCHAR2,
  p_svrtreq_surname               IN  VARCHAR2,
  p_svrtreq_prefix                IN  VARCHAR2,
  p_svrtreq_firstname             IN  VARCHAR2,
  p_svrtreq_firstmidname          IN  VARCHAR2,
  p_svrtreq_secondmidname         IN  VARCHAR2,
  p_svrtreq_formersurname         IN  VARCHAR2,
  p_svrtreq_student_no_1          IN  VARCHAR2,
  p_svrtreq_student_no_2          IN  VARCHAR2,
  p_svrtreq_student_no_3          IN  VARCHAR2) IS

 BEGIN

  INSERT INTO svrtreq
       ( svrtreq_bgn02,
         svrtreq_trans_date,
         svrtreq_purpose_cde,
         svrtreq_action_cde,
         svrtreq_birth_date,
         svrtreq_gender,
         svrtreq_exit_date,
         svrtreq_ocas_appnum,
         svrtreq_sin,
         svrtreq_surname,
         svrtreq_prefix,
         svrtreq_firstname,
         svrtreq_firstmidname,
         svrtreq_secondmidname,
         svrtreq_formersurname,
         svrtreq_student_no_1,
         svrtreq_student_no_2,
         svrtreq_student_no_3,
         svrtreq_state_ind,
         svrtreq_completion_ind,
         svrtreq_data_origin,
         svrtreq_user_id,
         svrtreq_activity_date )
  VALUES
       ( p_svrtreq_bgn02,
         TO_DATE(p_svrtreq_trans_date||RPAD(SUBSTR(p_svrtreq_trans_time,1,6),6,'0'),'yyyymmddhh24miss'),
         p_svrtreq_purpose_cde,
         p_svrtreq_action_cde,
         TO_DATE(p_svrtreq_birth_date,'yyyymmdd'),
         p_svrtreq_gender,
         TO_DATE(p_svrtreq_exit_date, 'yyyymmdd'),
         p_svrtreq_ocas_appnum,
         p_svrtreq_sin,
         p_svrtreq_surname,
         p_svrtreq_prefix,
         p_svrtreq_firstname,
         p_svrtreq_firstmidname,
         p_svrtreq_secondmidname,
         p_svrtreq_formersurname,
         p_svrtreq_student_no_1,
         p_svrtreq_student_no_2,
         p_svrtreq_student_no_3,
        'P',
        '~',
        'EDI',
         USER,
         TRUNC(SYSDATE) );

 END insert_svrtreq_record;

/*----------------------------------------------------------------------------*/
/* Delete a record in the "SVRTREQ" table for the BGN NO in question.         */
/*----------------------------------------------------------------------------*/

 PROCEDURE delete_svrtreq_record
 (p_svrtreq_bgn02                 IN  VARCHAR2) IS

 BEGIN

  DELETE FROM svrtreq
   WHERE svrtreq_bgn02 = p_svrtreq_bgn02;

 END delete_svrtreq_record;

/*----------------------------------------------------------------------------*/
/* Insert a record into the "SVRTNTE" table.                                  */
/*----------------------------------------------------------------------------*/

 PROCEDURE insert_svrtnte_record
 (p_svrtnte_bgn02                 IN  VARCHAR2,
  p_svrtnte_note                  IN  VARCHAR2) IS

 BEGIN

  INSERT INTO svrtnte
       ( svrtnte_bgn02,
         svrtnte_note,
         svrtnte_data_origin,
         svrtnte_user_id,
         svrtnte_activity_date )
  VALUES
       ( p_svrtnte_bgn02,
         DECODE(SUBSTR(p_svrtnte_note,5,4),
        'DATE','SENDDATE='||SUBSTR(p_svrtnte_note,9,8),p_svrtnte_note),
        'EDI',
         USER,
         TRUNC(SYSDATE) );

 END insert_svrtnte_record;

/*----------------------------------------------------------------------------*/
/* Delete all records in the "SVRTNTE" table for the BGN NO in question.      */
/*----------------------------------------------------------------------------*/

 PROCEDURE delete_svrtnte_record
 (p_svrtnte_bgn02                 IN  VARCHAR2) IS

 BEGIN

  DELETE FROM svrtnte
   WHERE svrtnte_bgn02 = p_svrtnte_bgn02;

 END delete_svrtnte_record;

/*----------------------------------------------------------------------------*/
/* Try to determine which student the transcript request is for.              */
/*----------------------------------------------------------------------------*/

 PROCEDURE match_student_info
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_birth_date            IN  DATE,
  p_svrtreq_sex                   IN  VARCHAR2,
  p_svrtreq_ssn                   IN  VARCHAR2,
  p_svrtreq_last_name             IN  VARCHAR2,
  p_svrtreq_first_name            IN  VARCHAR2,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_match_ind             OUT VARCHAR2,
  p_spriden_pidm                  OUT NUMBER,
  p_svrtreq_id                    OUT VARCHAR2) IS

 t_spriden_pidm                   t_nmbr_array;
 t_spriden_id                     t_char_array;
 t_spriden_idx                    BINARY_INTEGER;

 CURSOR c5 IS
  SELECT DISTINCT b.spriden_pidm,
         b.spriden_id
    FROM spriden b,
         spbpers a
   WHERE a.spbpers_ssn               = p_svrtreq_ssn
     AND TRUNC(a.spbpers_birth_date) = TRUNC(p_svrtreq_birth_date)
     AND a.spbpers_pidm              = b.spriden_pidm
     AND b.spriden_change_ind IS NULL
     AND gukcmpr.f_compress_name(b.spriden_first_name)
       = gukcmpr.f_compress_name(p_svrtreq_first_name)
     AND gukcmpr.f_compress_name(b.spriden_last_name)
       = gukcmpr.f_compress_name(p_svrtreq_last_name);

 CURSOR c6 IS
  SELECT DISTINCT b.spriden_pidm,
         b.spriden_id
    FROM spriden b,
         spbpers a
   WHERE a.spbpers_ssn  = p_svrtreq_ssn
     AND a.spbpers_pidm = b.spriden_pidm
     AND b.spriden_change_ind IS NULL
     AND gukcmpr.f_compress_name(b.spriden_first_name)
       = gukcmpr.f_compress_name(p_svrtreq_first_name)
     AND gukcmpr.f_compress_name(b.spriden_last_name)
       = gukcmpr.f_compress_name(p_svrtreq_last_name);

 CURSOR c7 IS
  SELECT DISTINCT a.spriden_pidm,
         a.spriden_id
    FROM spbpers b,
         spriden a
   WHERE a.spriden_search_first_name = UPPER(p_svrtreq_first_name)
     AND a.spriden_search_last_name  = UPPER(p_svrtreq_last_name)
     AND a.spriden_change_ind IS NULL
     AND a.spriden_pidm              = b.spbpers_pidm
     AND TRUNC(b.spbpers_birth_date) = TRUNC(p_svrtreq_birth_date)
     AND b.spbpers_sex               = p_svrtreq_sex;

 BEGIN
  log_details('match_student_info',0,'','what are the values',p_svrtreq_birth_date || ' ' || p_svrtreq_sex || ' ' || p_svrtreq_ssn || ' ' || p_svrtreq_last_name || ' ' || p_svrtreq_first_name );


  p_svrtreq_state_ind  := 'M';
  p_svrtreq_match_ind  := 'N';
  p_spriden_pidm       :=  NULL;
  p_svrtreq_id         :=  NULL;

  IF  p_svrtreq_birth_date IS NOT NULL
  AND p_svrtreq_ssn        IS NOT NULL
  AND p_svrtreq_last_name  IS NOT NULL
  AND p_svrtreq_first_name IS NOT NULL
  THEN
      OPEN c5;
      FETCH c5 BULK COLLECT
       INTO t_spriden_pidm,
            t_spriden_id;
      CLOSE c5;
  END IF;

  IF  t_spriden_pidm.COUNT < 1
  AND p_svrtreq_ssn        IS NOT NULL
  AND p_svrtreq_last_name  IS NOT NULL
  AND p_svrtreq_first_name IS NOT NULL
  THEN
      OPEN c6;
      FETCH c6 BULK COLLECT
       INTO t_spriden_pidm,
            t_spriden_id;
      CLOSE c6;
  END IF;

  IF  t_spriden_pidm.COUNT < 1
  AND p_svrtreq_birth_date IS NOT NULL
  AND p_svrtreq_sex        IS NOT NULL
  AND p_svrtreq_last_name  IS NOT NULL
  AND p_svrtreq_first_name IS NOT NULL
  THEN
      OPEN c7;
      FETCH c7 BULK COLLECT
       INTO t_spriden_pidm,
            t_spriden_id;
      CLOSE c7;
  END IF;

  IF  t_spriden_pidm.COUNT = 1
  THEN
      p_svrtreq_state_ind    := 'H';
      p_svrtreq_match_ind    := 'X';
      p_spriden_pidm         :=  t_spriden_pidm(1);
      p_svrtreq_id           :=  t_spriden_id  (1);
  ELSIF  t_spriden_pidm.COUNT >  1
     THEN
         p_svrtreq_match_ind := 'D';
         t_spriden_idx       :=  1;

         WHILE (t_spriden_idx <= t_spriden_pidm.COUNT)
          LOOP

           insert_svrtdup_record
           (p_svrtreq_bgn02,
            t_spriden_pidm(t_spriden_idx));

           t_spriden_idx     := t_spriden_idx + 1;

          END LOOP;
  END IF;

 END match_student_info;
 
/*----------------------------------------------------------------------------*/
/* Try to determine which student the transcript request is for.              */
/*----------------------------------------------------------------------------*/
 PROCEDURE matchStudentInfo
(
	p_svrtreq_bgn02                 IN  svrtreq.svrtreq_bgn02%TYPE,
	p_svrtreq_birth_date            IN  svrtreq.svrtreq_birth_date%TYPE,
	p_svrtreq_sex                   IN  VARCHAR2,
	p_studentId                  	IN  spriden.spriden_id%TYPE,
	p_svrtreq_last_name             IN  svrtreq.svrtreq_surname%TYPE,
	p_svrtreq_first_name            IN  svrtreq.svrtreq_firstname%TYPE,
	p_svrtreq_state_ind             OUT VARCHAR2,
	p_svrtreq_match_ind             OUT VARCHAR2,
	p_spriden_pidm                  OUT NUMBER,
	p_svrtreq_id                    OUT VARCHAR2
)
IS
 t_spriden_pidm                   t_nmbr_array;
 t_spriden_id                     t_char_array;
 t_spriden_idx                    BINARY_INTEGER;

 CURSOR c5 IS
  SELECT DISTINCT b.spriden_pidm,
         b.spriden_id
    FROM spriden b,
         spbpers a
	WHERE b.spriden_id  = p_studentId
     AND TRUNC(a.spbpers_birth_date) = TRUNC(p_svrtreq_birth_date)
     AND a.spbpers_pidm              = b.spriden_pidm
     AND b.spriden_change_ind IS NULL
     AND gukcmpr.f_compress_name(b.spriden_first_name)
       = gukcmpr.f_compress_name(p_svrtreq_first_name)
     AND gukcmpr.f_compress_name(b.spriden_last_name)
       = gukcmpr.f_compress_name(p_svrtreq_last_name);

 /*CURSOR c6 IS
  SELECT DISTINCT b.spriden_pidm,
         b.spriden_id
    FROM spriden b,
         spbpers a
   WHERE a.spbpers_ssn  = p_svrtreq_ssn
     AND a.spbpers_pidm = b.spriden_pidm
     AND b.spriden_change_ind IS NULL
     AND gukcmpr.f_compress_name(b.spriden_first_name)
       = gukcmpr.f_compress_name(p_svrtreq_first_name)
     AND gukcmpr.f_compress_name(b.spriden_last_name)
       = gukcmpr.f_compress_name(p_svrtreq_last_name);*/

 CURSOR c7 IS
  SELECT DISTINCT a.spriden_pidm,
         a.spriden_id
    FROM spbpers b,
         spriden a
   WHERE a.spriden_search_first_name = UPPER(p_svrtreq_first_name)
     AND a.spriden_search_last_name  = UPPER(p_svrtreq_last_name)
     AND a.spriden_change_ind IS NULL
     AND a.spriden_pidm              = b.spbpers_pidm
     AND TRUNC(b.spbpers_birth_date) = TRUNC(p_svrtreq_birth_date)
     AND b.spbpers_sex               = p_svrtreq_sex;
BEGIN

  log_details('matchstudentinfo',0,'','what are the values',p_svrtreq_birth_date || ' ' || p_svrtreq_sex || ' ' || p_studentId || ' ' || p_svrtreq_last_name || ' ' || p_svrtreq_first_name );

	p_svrtreq_state_ind  := 'M';
	p_svrtreq_match_ind  := 'N';
	p_spriden_pidm       :=  NULL;
	p_svrtreq_id         :=  NULL;

  IF  p_svrtreq_birth_date IS NOT NULL
  AND p_studentId          IS NOT NULL
  AND p_svrtreq_last_name  IS NOT NULL
  AND p_svrtreq_first_name IS NOT NULL
  THEN
      OPEN c5;
      FETCH c5 BULK COLLECT
       INTO t_spriden_pidm,
            t_spriden_id;
      CLOSE c5;
  END IF;

  /*IF  t_spriden_pidm.COUNT < 1
  AND p_svrtreq_ssn        IS NOT NULL
  AND p_svrtreq_last_name  IS NOT NULL
  AND p_svrtreq_first_name IS NOT NULL
  THEN
      OPEN c6;
      FETCH c6 BULK COLLECT
       INTO t_spriden_pidm,
            t_spriden_id;
      CLOSE c6;
  END IF;*/

  IF  t_spriden_pidm.COUNT < 1
  AND p_svrtreq_birth_date IS NOT NULL
  AND p_svrtreq_sex        IS NOT NULL
  AND p_svrtreq_last_name  IS NOT NULL
  AND p_svrtreq_first_name IS NOT NULL
  THEN
      OPEN c7;
      FETCH c7 BULK COLLECT
       INTO t_spriden_pidm,
            t_spriden_id;
      CLOSE c7;
  END IF;

    Log_Details('matchstudentinfo',t_spriden_pidm.COUNT,'','what is the pidm count','check pidm value');

	IF  t_spriden_pidm.COUNT = 1 THEN
		p_svrtreq_state_ind    := 'H';
		p_svrtreq_match_ind    := 'X';
		p_spriden_pidm         :=  t_spriden_pidm(1);
		p_svrtreq_id           :=  t_spriden_id  (1);
	ELSIF  t_spriden_pidm.COUNT >  1 THEN     
		p_svrtreq_match_ind := 'D';
		t_spriden_idx       :=  1;

		WHILE (t_spriden_idx <= t_spriden_pidm.COUNT)
			LOOP
				insert_svrtdup_record
				(p_svrtreq_bgn02,
				t_spriden_pidm(t_spriden_idx));

				t_spriden_idx     := t_spriden_idx + 1;
			END LOOP;
	END IF;	
	log_Details('matchstudentinfo',t_spriden_pidm.COUNT,'','end of function',p_svrtreq_state_ind || ' ' || p_svrtreq_match_ind);
EXCEPTION
    WHEN OTHERS THEN
        Log_Error('matchStudentInfo',' ',p_studentId || ' ' || p_svrtreq_last_name || ' ' || SQLERRM); 
END matchStudentInfo;	

/*----------------------------------------------------------------------------*/
/* Insert a record into the "SVRTDUP" table.                                  */
/*----------------------------------------------------------------------------*/

 PROCEDURE insert_svrtdup_record
 (p_svrtdup_bgn02                 IN  VARCHAR2,
  p_svrtdup_pidm                  IN  NUMBER) IS

 BEGIN

  INSERT INTO svrtdup
       ( svrtdup_bgn02,
         svrtdup_pidm,
         svrtdup_data_origin,
         svrtdup_user_id,
         svrtdup_activity_date )
  VALUES
       ( p_svrtdup_bgn02,
         p_svrtdup_pidm,
        'EDI',
         USER,
         TRUNC(SYSDATE) );

 END insert_svrtdup_record;

/*----------------------------------------------------------------------------*/
/* Delete all records in the "SVRTDUP" table for the BGN NO in question.      */
/*----------------------------------------------------------------------------*/

 PROCEDURE delete_svrtdup_record
 (p_svrtdup_bgn02                 IN  VARCHAR2) IS

 BEGIN

  DELETE FROM svrtdup
   WHERE svrtdup_bgn02 = p_svrtdup_bgn02;

 END delete_svrtdup_record;

/*----------------------------------------------------------------------------*/
/* Check to see if the student has been flagged as deceased.                  */
/*----------------------------------------------------------------------------*/

 PROCEDURE check_student_deceased
 (p_spbpers_pidm                  IN  NUMBER,
  p_spbpers_dead_ind              OUT VARCHAR2) IS

 CURSOR c9 IS
  SELECT UPPER(NVL(spbpers_dead_ind,'n'))
    FROM spbpers
   WHERE spbpers_pidm = p_spbpers_pidm
     AND NVL(spbpers_dead_ind,'n') = 'Y';

 BEGIN

  p_spbpers_dead_ind := NULL;

  OPEN c9;
  FETCH c9
   INTO p_spbpers_dead_ind;
  CLOSE c9;

 END check_student_deceased;

/*----------------------------------------------------------------------------*/
/* Check to see if a hold has been placed on the student's transcript.        */
/*----------------------------------------------------------------------------*/

 PROCEDURE check_for_holds
 (p_spriden_pidm                  IN  NUMBER,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_hold_ind              OUT VARCHAR2) IS

 v_tbraccd_balance NUMBER;

 CURSOR c10 IS
  SELECT 'H'
    FROM stvhldd b,
         sprhold a
   WHERE a.sprhold_pidm = p_spriden_pidm
     AND TRUNC(SYSDATE)
 BETWEEN TRUNC(a.sprhold_from_date)
     AND TRUNC(a.sprhold_to_date)
     AND NVL(a.sprhold_release_ind,'n')   != 'Y'
     AND a.sprhold_hldd_code               =  b.stvhldd_code
     AND NVL(b.stvhldd_trans_hold_ind,'n') = 'Y';

 CURSOR c11 IS
  SELECT NVL(SUM(tbraccd_balance),0)
    FROM tbraccd
   WHERE tbraccd_pidm = p_spriden_pidm;

 BEGIN

  p_svrtreq_state_ind := 'H';
  p_svrtreq_hold_ind  := 'N';

  OPEN c10;
  FETCH c10
   INTO p_svrtreq_hold_ind;
  CLOSE c10;

  IF  p_svrtreq_hold_ind = 'N'
  THEN
      v_tbraccd_balance := 0;

      OPEN c11;
      FETCH c11
       INTO v_tbraccd_balance;
      CLOSE c11;

      IF  v_tbraccd_balance > 0
      THEN
          p_svrtreq_hold_ind  := '$';
      ELSE
          p_svrtreq_state_ind := 'D';
      END IF;
  END IF;

 END check_for_holds;

/*----------------------------------------------------------------------------*/
/* Determine what the value of the "senddate" field should be.                */
/*----------------------------------------------------------------------------*/

 PROCEDURE determine_send_date
 (p_svrtreq_action_cde            IN  VARCHAR2,
  p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_send_date             OUT DATE,
  p_svrtreq_state_ind             OUT VARCHAR2,
  p_svrtreq_date_ind              OUT VARCHAR2,
  p_svrtreq_reason_cde            OUT VARCHAR2,
  p_error_message                 OUT VARCHAR2) IS

 v_svrtnte_data_value             svrtnte.svrtnte_note%TYPE;
 v_gtvsdax_term_code              gtvsdax.gtvsdax_translation_code%TYPE;
 v_gtvsdax_term_date_offset       gtvsdax.gtvsdax_translation_code%TYPE;
 v_term_date_offset               NUMBER;

 BEGIN

  p_svrtreq_send_date  :=  NULL;
  p_svrtreq_state_ind  := 'D';
  p_svrtreq_date_ind   :=  NULL;
  p_svrtreq_reason_cde :=  NULL;
  p_error_message      :=  NULL;

  IF  p_svrtreq_action_cde  = 'R4'
  THEN
      p_svrtreq_state_ind  := 'C';
      p_svrtreq_date_ind   := 'R4';
      p_svrtreq_reason_cde := '48';
  END IF;

  IF  p_svrtreq_action_cde  = 'R2'
  THEN
      p_svrtreq_send_date  :=  TRUNC(SYSDATE);
      p_svrtreq_state_ind  := 'C';
  END IF;

  IF  p_svrtreq_action_cde  = 'OT'
  THEN
      get_svrtnte_note
      (p_svrtreq_bgn02,
      'SENDDATE=',
       v_svrtnte_data_value);

      IF  v_svrtnte_data_value IS NULL
      THEN
          p_error_message     := 'TNTE - SENDDATE= record not found';
      ELSE
          p_svrtreq_send_date :=  TO_DATE(v_svrtnte_data_value,'yyyymmdd');
          p_svrtreq_state_ind := 'C';

          IF  TRUNC(p_svrtreq_send_date) > TRUNC(SYSDATE)
          THEN
              p_svrtreq_reason_cde := '48';
          END IF;
      END IF;
  END IF;

  IF  p_svrtreq_action_cde = 'R3'
  THEN
      get_svrtnte_note
      (p_svrtreq_bgn02,
      'TERM=',
       v_svrtnte_data_value);

      IF  v_svrtnte_data_value IS NULL
      THEN
          p_error_message := 'TNTE - TERM= record not found';
      ELSE
          IF  NVL(SUBSTR(p_svrtreq_bgn02,1,1),'~') = 'C'
          THEN
              get_gtvsdax_translation_code
              (v_svrtnte_data_value,
              'TERM',
               v_gtvsdax_term_code);
          ELSE
              get_gtvsdax_translation_code
              (v_svrtnte_data_value,
              'TERMU',
               v_gtvsdax_term_code);
          END IF;

          IF  v_gtvsdax_term_code IS NULL
          THEN
              p_svrtreq_date_ind := 'IT';
          ELSE
              get_stvterm_end_date
              (v_gtvsdax_term_code,
               p_svrtreq_send_date);

              IF  p_svrtreq_send_date IS NULL
              THEN
                  p_svrtreq_date_ind  := 'IT';
              ELSE
                  p_svrtreq_state_ind := 'C';

                  get_gtvsdax_translation_code
                  (NULL,
                   'TERM DATE OFFSET',
                   v_gtvsdax_term_date_offset);

                  IF  v_gtvsdax_term_date_offset IS NOT NULL
                  THEN
                      IF  SUBSTR(v_gtvsdax_term_date_offset,1,1) IN ('+','-')
                      THEN
                          v_term_date_offset := TO_NUMBER(SUBSTR(v_gtvsdax_term_date_offset,2,10));

                          IF  SUBSTR(v_gtvsdax_term_date_offset,1,1) = '-'
                          THEN
                              v_term_date_offset := v_term_date_offset * -1;
                          END IF;
                      ELSE
                          v_term_date_offset := TO_NUMBER(v_gtvsdax_term_date_offset);
                      END IF;

                      p_svrtreq_send_date := p_svrtreq_send_date + v_term_date_offset;
                  END IF;

                  IF  TRUNC(p_svrtreq_send_date) > TRUNC(SYSDATE)
                  THEN
                      p_svrtreq_reason_cde := '48';
                  END IF;
              END IF;
          END IF;
      END IF;
  END IF;

 END determine_send_date;

/*----------------------------------------------------------------------------*/
/* Get the note field from the "SVRTNTE" table.                               */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_svrtnte_note
 (p_svrtnte_bgn02                 IN  VARCHAR2,
  p_record_type                   IN  VARCHAR2,
  p_svrtnte_note                  OUT VARCHAR2) IS

 CURSOR c12 IS
  SELECT SUBSTR(svrtnte_note,INSTR(svrtnte_note,'=')+1,8)
    FROM svrtnte
   WHERE svrtnte_bgn02 = p_svrtnte_bgn02
     AND svrtnte_note LIKE p_record_type||'%';

 BEGIN

  p_svrtnte_note := NULL;

  OPEN c12;
  FETCH c12
   INTO p_svrtnte_note;
  CLOSE c12;

 END get_svrtnte_note;

/*----------------------------------------------------------------------------*/
/* Get the term end date from the "STVTERM" table.                            */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_stvterm_end_date
 (p_stvterm_code                  IN  VARCHAR2,
  p_stvterm_end_date              OUT DATE) IS

 CURSOR c13 IS
  SELECT TRUNC(stvterm_end_date)
    FROM stvterm
   WHERE stvterm_code = p_stvterm_code;

 BEGIN

  p_stvterm_end_date := NULL;

  OPEN c13;
  FETCH c13
   INTO p_stvterm_end_date;
  CLOSE c13;

 END get_stvterm_end_date;

/*----------------------------------------------------------------------------*/
/* Insert a record into the "SHTTRAN" table.                                  */
/*----------------------------------------------------------------------------*/

 PROCEDURE insert_shttran_record
 (p_spriden_pidm                  IN  NUMBER,
  p_spriden_id                    IN  VARCHAR2,
  p_svrtreq_bgn02                 IN  VARCHAR2,
  p_shttran_seq_no                OUT NUMBER) IS

  v_current_term_code             stvterm.stvterm_code%TYPE;
  v_sgbstdn_term_code_eff         sgbstdn.sgbstdn_term_code_eff%TYPE;
  v_shttran_sbgi_code             shttran.shttran_sbgi_code%TYPE;
  v_sobsbgi_street_line1          sobsbgi.sobsbgi_street_line1%TYPE;
  v_sobsbgi_street_line2          sobsbgi.sobsbgi_street_line2%TYPE;
  v_sobsbgi_street_line3          sobsbgi.sobsbgi_street_line3%TYPE;
  v_sobsbgi_city                  sobsbgi.sobsbgi_city%TYPE;
  v_sobsbgi_stat_code             sobsbgi.sobsbgi_stat_code%TYPE;
  v_sobsbgi_zip                   sobsbgi.sobsbgi_zip%TYPE;
  v_sobsbgi_natn_code             sobsbgi.sobsbgi_natn_code%TYPE;
  v_sfbetrm_term_code             sfbetrm.sfbetrm_term_code%TYPE;
  v_gtvsdax_tprt_code             shttran.shttran_tprt_code%TYPE;

 BEGIN

  get_shttran_seq_no
  (p_svrtreq_bgn02,
   p_spriden_id,
   p_spriden_pidm,
   p_shttran_seq_no);

  gc_common_pkg.pw_get_current_term_code
  (v_current_term_code);

  v_current_term_code := SUBSTR(v_current_term_code,1,5)||'5';

  get_sgbstdn_term_code_eff
  (p_spriden_pidm,
   v_current_term_code,
   v_sgbstdn_term_code_eff);

  IF  SUBSTR(p_svrtreq_bgn02,1,1) = 'C'
  THEN
      v_shttran_sbgi_code := 'OCAS';
  ELSE
      v_shttran_sbgi_code := 'OUAC';
  END IF;

  get_requestor_address
  (v_shttran_sbgi_code,
   v_sobsbgi_street_line1,
   v_sobsbgi_street_line2,
   v_sobsbgi_street_line3,
   v_sobsbgi_city,
   v_sobsbgi_stat_code,
   v_sobsbgi_zip,
   v_sobsbgi_natn_code);

  get_gtvsdax_translation_code
  (NULL,
   'TPRT',
   v_gtvsdax_tprt_code);

  get_sfbetrm_term_code
  (p_spriden_pidm,
   v_current_term_code,
   v_sfbetrm_term_code);

  INSERT INTO shttran
       ( shttran_user,
         shttran_pidm,
         shttran_seq_no,
         shttran_id,
         shttran_type,
         shttran_term,
         shttran_levl_code,
         shttran_addr_name,
         shttran_street1,
         shttran_street2,
         shttran_street3,
         shttran_city,
         shttran_stat_code,
         shttran_zip,
         shttran_request_date,
         shttran_activity_date,
         shttran_tprt_code,
         shttran_no_copies,
         shttran_official_ind,
         shttran_term_code_in_prg,
         shttran_natn_code,
         shttran_sbgi_code,
         shttran_hold_grde_ind,
         shttran_hold_degr_ind )
  VALUES
       ( USER,
         p_spriden_pidm,
         p_shttran_seq_no,
         p_spriden_id,
        'E',
         v_sgbstdn_term_code_eff,
        'AL',
         v_shttran_sbgi_code,
         v_sobsbgi_street_line1,
         v_sobsbgi_street_line2,
         v_sobsbgi_street_line3,
         v_sobsbgi_city,
         v_sobsbgi_stat_code,
         v_sobsbgi_zip,
         TRUNC(SYSDATE),
         TRUNC(SYSDATE),
         v_gtvsdax_tprt_code,
         1,
        'Y',
         v_sfbetrm_term_code,
         v_sobsbgi_natn_code,
         v_shttran_sbgi_code,
        'N',
        'N' );

 END insert_shttran_record;

/*----------------------------------------------------------------------------*/
/* Insert a record into the "SHTTRAN" table.                                  */
/*----------------------------------------------------------------------------*/
 PROCEDURE write_transcript_record
(
	p_spriden_pidm                  IN  NUMBER,
	p_spriden_id                    IN  VARCHAR2,
	p_svrtreq_bgn02                 IN  VARCHAR2,
	p_shttran_seq_no                OUT NUMBER
)
IS
	v_current_term_code             stvterm.stvterm_code%TYPE;
	v_sgbstdn_term_code_eff         sgbstdn.sgbstdn_term_code_eff%TYPE;
	v_shttran_sbgi_code             shttran.shttran_sbgi_code%TYPE;
	v_sobsbgi_street_line1          sobsbgi.sobsbgi_street_line1%TYPE;
	v_sobsbgi_street_line2          sobsbgi.sobsbgi_street_line2%TYPE;
	v_sobsbgi_street_line3          sobsbgi.sobsbgi_street_line3%TYPE;
	v_sobsbgi_city                  sobsbgi.sobsbgi_city%TYPE;
	v_sobsbgi_stat_code             sobsbgi.sobsbgi_stat_code%TYPE;
	v_sobsbgi_zip                   sobsbgi.sobsbgi_zip%TYPE;
	v_sobsbgi_natn_code             sobsbgi.sobsbgi_natn_code%TYPE;
	v_sfbetrm_term_code             sfbetrm.sfbetrm_term_code%TYPE;
	v_gtvsdax_tprt_code             shttran.shttran_tprt_code%TYPE;
	
BEGIN
	get_shttran_seq_no(p_svrtreq_bgn02,p_spriden_id, p_spriden_pidm, p_shttran_seq_no);
	
	gc_common_pkg.pw_get_current_term_code(v_current_term_code);
  

	v_current_term_code := SUBSTR(v_current_term_code,1,5)||'5';

	get_sgbstdn_term_code_eff(p_spriden_pidm,v_current_term_code,v_sgbstdn_term_code_eff);

	IF  SUBSTR(p_svrtreq_bgn02,1,1) = 'C' THEN
		v_shttran_sbgi_code := 'OCAS';
	ELSE
		v_shttran_sbgi_code := 'OUAC';
	END IF;

	get_requestor_address
	(
		v_shttran_sbgi_code,
		v_sobsbgi_street_line1,
		v_sobsbgi_street_line2,
		v_sobsbgi_street_line3,
		v_sobsbgi_city,
		v_sobsbgi_stat_code,
		v_sobsbgi_zip,
		v_sobsbgi_natn_code
	);

	get_gtvsdax_translation_code('XML', 'TPRT','XML',v_gtvsdax_tprt_code);	
 
	get_sfbetrm_term_code(p_spriden_pidm, v_current_term_code, v_sfbetrm_term_code);
 
	INSERT INTO shttran
	( 
		shttran_user,
		shttran_pidm,
		shttran_seq_no,
		shttran_id,
		shttran_type,
		shttran_term,
		shttran_levl_code,
		shttran_addr_name,
		shttran_street1,
		shttran_street2,
		shttran_street3,
		shttran_city,
		shttran_stat_code,
		shttran_zip,
		shttran_request_date,
		shttran_activity_date,
		shttran_tprt_code,
		shttran_no_copies,
		shttran_official_ind,
		shttran_term_code_in_prg,
		shttran_natn_code,
		shttran_sbgi_code,
		shttran_hold_grde_ind,
		shttran_hold_degr_ind ,
		shttran_user_id,
		shttran_data_origin
	)
	VALUES
	( 
		USER,
		p_spriden_pidm,
		p_shttran_seq_no,
		p_spriden_id,
		'P',
		v_sgbstdn_term_code_eff,
		'AL',
		v_shttran_sbgi_code,
		v_sobsbgi_street_line1,
		v_sobsbgi_street_line2,
		v_sobsbgi_street_line3,
		v_sobsbgi_city,
		v_sobsbgi_stat_code,
		v_sobsbgi_zip,
		TRUNC(SYSDATE),
		TRUNC(SYSDATE),
		v_gtvsdax_tprt_code,
		1,
		'Y',
		v_sfbetrm_term_code,
		v_sobsbgi_natn_code,
		v_shttran_sbgi_code,
		'N',
		'N',
		USER,
		'deletexml'
	);
	COMMIT;
EXCEPTION
    WHEN OTHERS THEN
        Log_Error('write_transcript_record',p_spriden_pidm,p_spriden_id || ' ' || SQLERRM); 
END write_transcript_record;  

/*----------------------------------------------------------------------------*/
/* Get the next sequence number for the student from the "SHTTRAN" table.     */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_shttran_seq_no
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_id                    IN  VARCHAR2,
  p_shttran_pidm                  IN  NUMBER,
  p_shttran_seq_no                OUT NUMBER) IS

 CURSOR c14 IS
  SELECT NVL(MAX(svrtreq_seq_no),0) + 1
    FROM svrtreq
   WHERE svrtreq_bgn02 = p_svrtreq_bgn02
  UNION
  SELECT NVL(MAX(svrtreq_seq_no),0) + 1
    FROM svrtreq
   WHERE svrtreq_id    = p_svrtreq_id
  UNION
  SELECT NVL(MAX(shttran_seq_no),0) + 1
    FROM shttran
   WHERE shttran_pidm  = p_shttran_pidm
   ORDER BY 1 DESC;

 BEGIN

  p_shttran_seq_no := 1;

  OPEN c14;
  FETCH c14
   INTO p_shttran_seq_no;
  CLOSE c14;

 END get_shttran_seq_no;

/*----------------------------------------------------------------------------*/
/* Get the most recent term code for the student from the "SGBSTDN" table.    */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_sgbstdn_term_code_eff
 (p_sgbstdn_pidm                  IN  NUMBER,
  p_current_term_code             IN  VARCHAR2,
  p_sgbstdn_term_code_eff         OUT VARCHAR2) IS

 CURSOR c15 IS
  SELECT sgbstdn_term_code_eff
    FROM saturn.sgbstdn
   WHERE sgbstdn_pidm = p_sgbstdn_pidm
     AND sgbstdn_term_code_eff
       = (SELECT MAX(sgbstdn_term_code_eff)
            FROM saturn.sgbstdn
           WHERE sgbstdn_pidm = p_sgbstdn_pidm
             AND sgbstdn_term_code_eff <= p_current_term_code);

 BEGIN

  p_sgbstdn_term_code_eff := NULL;

  OPEN c15;
  FETCH c15
   INTO p_sgbstdn_term_code_eff;
  CLOSE c15;

 END get_sgbstdn_term_code_eff;

/*----------------------------------------------------------------------------*/
/* Get the requestor's address information from the "SOBSBGI" table.          */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_requestor_address
 (p_sobsbgi_sbgi_code             IN  VARCHAR2,
  p_sobsbgi_street_line1          OUT VARCHAR2,
  p_sobsbgi_street_line2          OUT VARCHAR2,
  p_sobsbgi_street_line3          OUT VARCHAR2,
  p_sobsbgi_city                  OUT VARCHAR2,
  p_sobsbgi_stat_code             OUT VARCHAR2,
  p_sobsbgi_zip                   OUT VARCHAR2,
  p_sobsbgi_natn_code             OUT VARCHAR2) IS

 CURSOR c16 IS
  SELECT a.sobsbgi_street_line1,
         a.sobsbgi_street_line2,
         a.sobsbgi_street_line3,
         a.sobsbgi_city,
         a.sobsbgi_stat_code,
         a.sobsbgi_zip,
         a.sobsbgi_natn_code
    FROM sobsbgi a
   WHERE a.sobsbgi_sbgi_code = p_sobsbgi_sbgi_code;

 BEGIN

  p_sobsbgi_street_line1 := NULL;
  p_sobsbgi_street_line2 := NULL;
  p_sobsbgi_street_line3 := NULL;
  p_sobsbgi_city         := NULL;
  p_sobsbgi_stat_code    := NULL;
  p_sobsbgi_zip          := NULL;
  p_sobsbgi_natn_code    := NULL;

  OPEN c16;
  FETCH c16
   INTO p_sobsbgi_street_line1,
        p_sobsbgi_street_line2,
        p_sobsbgi_street_line3,
        p_sobsbgi_city,
        p_sobsbgi_stat_code,
        p_sobsbgi_zip,
        p_sobsbgi_natn_code;
  CLOSE c16;

 END get_requestor_address;

/*----------------------------------------------------------------------------*/
/* Get the student's most recent term code from the "SFBETRM" table.          */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_sfbetrm_term_code
 (p_sfbetrm_pidm                  IN  NUMBER,
  p_current_term_code             IN  VARCHAR2,
  p_sfbetrm_term_code             OUT VARCHAR2) IS

 CURSOR c17 IS
  SELECT MAX(sfbetrm_term_code)
    FROM sfbetrm
   WHERE sfbetrm_pidm       = p_sfbetrm_pidm
     AND sfbetrm_term_code <= p_current_term_code;

 BEGIN

  p_sfbetrm_term_code := NULL;

  OPEN c17;
  FETCH c17
   INTO p_sfbetrm_term_code;
  CLOSE c17;

 END get_sfbetrm_term_code;

/*----------------------------------------------------------------------------*/
/* Write lines to the output report.                                          */
/*----------------------------------------------------------------------------*/

 PROCEDURE write_report_lines
 (p_report_detail_line            IN  VARCHAR2,
  p_report_page_no                IN  OUT NUMBER,
  p_report_line_cnt               IN  OUT NUMBER) IS

 BEGIN

  IF  p_report_line_cnt >= 85
  THEN
      p_report_page_no  := p_report_page_no + 1;
      DBMS_OUTPUT.put_line('SVPTREQ                                                   GEORGIAN COLLEGE                                                PAGE:   '||LPAD(TO_CHAR(p_report_page_no),2,'0'));
      DBMS_OUTPUT.put_line(TO_CHAR(SYSDATE,'yyyy-Mon-dd hh24:mi')||'                            EDI Student Transcript Request Error Report');
      DBMS_OUTPUT.put_line('.');
      DBMS_OUTPUT.put_line('.                 Trans  Purpose Action                                   Birth');
      DBMS_OUTPUT.put_line('BGN02 Number      Date     Code   Code  First Name      Last Name         Date      SIN    Message');
      DBMS_OUTPUT.put_line('--------------- -------- ------- ------ --------------- --------------- -------- --------- -----------------------------------------');
      p_report_line_cnt := 6;
  END IF;

  DBMS_OUTPUT.put_line(p_report_detail_line);
  p_report_line_cnt := p_report_line_cnt + 1;

 END write_report_lines;

/*----------------------------------------------------------------------------*/
/* Process the "SVRTREQ" records where the reason code is NOT blank (this     */
/* means that the student's request for a transcript has been refused for     */
/* whatever reason) and write the information to the "sedi147.dat" file.      */
/*----------------------------------------------------------------------------*/

 PROCEDURE process_refusals
 (p_svptreq_job_no                IN  NUMBER) IS

 v_gwrfile_line                   gwrfile.gwrfile_line%TYPE;
 v_gwrfile_data                   gwrfile.gwrfile_data%TYPE;

 v_svrtreq_bgn02                  svrtreq.svrtreq_bgn02%TYPE;
 v_svrtreq_trans_date             VARCHAR2(8);
 v_svrtreq_trans_time             VARCHAR2(6);
 v_svrtreq_ocas_appnum            svrtreq.svrtreq_ocas_appnum%TYPE;
 v_svrtreq_surname                svrtreq.svrtreq_surname%TYPE;
 v_svrtreq_prefix                 svrtreq.svrtreq_prefix%TYPE;
 v_svrtreq_firstname              svrtreq.svrtreq_firstname%TYPE;
 v_svrtreq_student_no_1           svrtreq.svrtreq_student_no_1%TYPE;
 v_svrtreq_student_no_2           svrtreq.svrtreq_student_no_2%TYPE;
 v_svrtreq_student_no_3           svrtreq.svrtreq_student_no_3%TYPE;
 v_svrtreq_id                     svrtreq.svrtreq_id%TYPE;
 v_svrtreq_reason_cde             svrtreq.svrtreq_reason_cde%TYPE;

 v_ocas_ouac_code                 VARCHAR2(4);

 v_svptreq_seq_no                 NUMBER;
 v_svptreq_147_data               VARCHAR2(132);

 v_gtvsdax_inst_code              VARCHAR2(15);

 v_spriden_pidm                   spriden.spriden_id%TYPE;

 v_svrtreq_completion_ind         svrtreq.svrtreq_completion_ind%TYPE;

 CURSOR c18 IS
  SELECT gwrfile_line,
         gwrfile_data
    FROM gwrfile
   WHERE gwrfile_sequence        =  p_svptreq_job_no
     AND LOWER(gwrfile_jobname)  = 'svptreq'
     AND LOWER(gwrfile_filename) LIKE '%sedi147%'
   ORDER BY 1;

 CURSOR c19 IS
  SELECT svrtreq_bgn02,
         TO_CHAR(SYSDATE,'yyyymmdd'),
         TO_CHAR(SYSDATE,'hh24miss'),
         svrtreq_ocas_appnum,
         svrtreq_surname,
         svrtreq_prefix,
         svrtreq_firstname,
         svrtreq_student_no_1,
         svrtreq_student_no_2,
         svrtreq_student_no_3,
         svrtreq_id,
         svrtreq_reason_cde
    FROM svrtreq
   WHERE svrtreq_state_ind  != 'X'
     AND svrtreq_completion_ind NOT IN ('130','147')
     AND svrtreq_reason_cde IS NOT NULL
     FOR UPDATE OF svrtreq_state_ind;

 BEGIN

  v_svptreq_seq_no := 0;

  OPEN c18;
  LOOP

   FETCH c18
    INTO v_gwrfile_line,
         v_gwrfile_data;

   EXIT WHEN c18%NOTFOUND;

   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_gwrfile_data);

  END LOOP;
  CLOSE c18;

  OPEN c19;
  LOOP

   FETCH c19
    INTO v_svrtreq_bgn02,
         v_svrtreq_trans_date,
         v_svrtreq_trans_time,
         v_svrtreq_ocas_appnum,
         v_svrtreq_surname,
         v_svrtreq_prefix,
         v_svrtreq_firstname,
         v_svrtreq_student_no_1,
         v_svrtreq_student_no_2,
         v_svrtreq_student_no_3,
         v_svrtreq_id,
         v_svrtreq_reason_cde;

   EXIT WHEN c19%NOTFOUND;

   IF  SUBSTR(v_svrtreq_bgn02,1,1) = 'C'
   THEN
       v_ocas_ouac_code := 'OCAS';
   ELSE
       v_ocas_ouac_code := 'OUAC';
   END IF;

   v_svptreq_147_data := '@H@|147|'||v_ocas_ouac_code;
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   v_svptreq_147_data := '@D@';
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   v_svptreq_147_data := 'BGN|'||v_svrtreq_reason_cde||'|'||v_svrtreq_bgn02||'|'||v_svrtreq_trans_date||'|'||v_svrtreq_trans_time||'|ET';
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   IF  v_svrtreq_reason_cde IN ('01','12','21','22','48')
   THEN
       v_svptreq_147_data := 'AAA|Y';
   ELSE
       v_svptreq_147_data := 'AAA|N';
   END IF;

   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   v_svptreq_147_data := 'REF|48|'||v_svrtreq_ocas_appnum;
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   IF  v_svrtreq_student_no_1 IS NOT NULL
   THEN
       v_svptreq_147_data := 'REF|LR|'||v_svrtreq_student_no_1;
       insert_svptreq_record
       (p_svptreq_job_no,
        v_svptreq_seq_no,
        v_svptreq_147_data);
   END IF;

   IF  v_svrtreq_student_no_2 IS NOT NULL
   THEN
       v_svptreq_147_data := 'REF|LR|'||v_svrtreq_student_no_2;
       insert_svptreq_record
       (p_svptreq_job_no,
        v_svptreq_seq_no,
        v_svptreq_147_data);
   END IF;

   IF  v_svrtreq_student_no_3 IS NOT NULL
   THEN
       v_svptreq_147_data := 'REF|LR|'||v_svrtreq_student_no_3;
       insert_svptreq_record
       (p_svptreq_job_no,
        v_svptreq_seq_no,
        v_svptreq_147_data);
   END IF;

   get_gtvsdax_translation_code
   (NULL,
   'EDICSIS',
    v_gtvsdax_inst_code);

   v_svptreq_147_data := 'N1|AS||CB|'||v_gtvsdax_inst_code;
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   v_svptreq_147_data := 'N1|AT|'||v_ocas_ouac_code||'|ZZ|'||v_ocas_ouac_code;
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   v_svptreq_147_data := 'IN1|1|04';
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   v_svptreq_147_data := 'IN2|05|'||v_svrtreq_surname;
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   IF  v_svrtreq_prefix IS NULL
   THEN
       get_spriden_pidm
       (v_svrtreq_id,
        v_spriden_pidm);

       IF  v_spriden_pidm IS NOT NULL
       THEN
           get_spbpers_name_prefix
           (v_spriden_pidm,
            v_svrtreq_prefix);
       ELSE
           v_svrtreq_prefix := 'UNKNOWN';
       END IF;
   END IF;

   v_svptreq_147_data := 'IN2|01|'||v_svrtreq_prefix;
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   v_svptreq_147_data := 'IN2|02|'||v_svrtreq_firstname;
   insert_svptreq_record
   (p_svptreq_job_no,
    v_svptreq_seq_no,
    v_svptreq_147_data);

   IF  v_svrtreq_reason_cde      = '48'
   THEN
       v_svrtreq_completion_ind := '~';
   ELSE
       v_svrtreq_completion_ind := '147';
   END IF;

   update_svrtreq_record
   (v_svrtreq_bgn02,
    NULL,
   'C',
    NULL,
    NULL,
    NULL,
    v_svrtreq_completion_ind,
    NULL,
    NULL,
    NULL);

  END LOOP;
  CLOSE c19;

  COMMIT;

 END process_refusals;

/*----------------------------------------------------------------------------*/
/* Insert a record into the "SVPTREQ_TAB" table.                              */
/*----------------------------------------------------------------------------*/

 PROCEDURE insert_svptreq_record
 (p_svptreq_id                    IN  NUMBER,
  p_svptreq_seq_no                IN  OUT NUMBER,
  p_svptreq_147_data              IN  VARCHAR2) IS

 BEGIN

  p_svptreq_seq_no := p_svptreq_seq_no + 1;

  INSERT INTO svptreq_tab
       ( svptreq_id,
         svptreq_date,
         svptreq_seq_no,
         svptreq_147_data )
  VALUES
       ( p_svptreq_id,
         TRUNC(SYSDATE),
         p_svptreq_seq_no,
         p_svptreq_147_data );

 END insert_svptreq_record;

/*----------------------------------------------------------------------------*/
/* Get the term code from the "GTVSDAX" table.                                */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_gtvsdax_translation_code
 (p_gtvsdax_external_code         IN  VARCHAR2,
  p_gtvsdax_external_code_group   IN  VARCHAR2,
  p_gtvsdax_translation_code      OUT VARCHAR2) IS

 CURSOR c19 IS
  SELECT NVL(LTRIM(gtvsdax_translation_code,'GEORGIAN'),gtvsdax_external_code)
    FROM gtvsdax
   WHERE UPPER(gtvsdax_external_code)       =  NVL(p_gtvsdax_external_code,UPPER(gtvsdax_external_code))
     AND UPPER(gtvsdax_internal_code)       = 'EDIONT'
     AND UPPER(gtvsdax_internal_code_group) =  p_gtvsdax_external_code_group;

 BEGIN

  p_gtvsdax_translation_code := NULL;

  OPEN c19;
  FETCH c19
   INTO p_gtvsdax_translation_code;
  CLOSE c19;

 END get_gtvsdax_translation_code;

/*----------------------------------------------------------------------------*/
/* Get the student's PIDM from the "SPRIDEN" table.                           */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_spriden_pidm
 (p_spriden_id                    IN  VARCHAR2,
  p_spriden_pidm                  OUT NUMBER) IS

 CURSOR c20 IS
  SELECT MAX(spriden_pidm)
    FROM spriden
   WHERE spriden_id = p_spriden_id
     AND spriden_change_ind IS NULL;

 BEGIN

  p_spriden_pidm := NULL;

  OPEN c20;
  FETCH c20
   INTO p_spriden_pidm;
  CLOSE c20;

 END get_spriden_pidm;

/*----------------------------------------------------------------------------*/
/* Get the student's name prefix from the "SPBPERS" table.                    */
/*----------------------------------------------------------------------------*/

 PROCEDURE get_spbpers_name_prefix
 (p_spbpers_pidm                  IN  NUMBER,
  p_spbpers_name_prefix           OUT VARCHAR2) IS

 CURSOR c21 IS
  SELECT NVL(spbpers_name_prefix,'UNKNOWN')
    FROM spbpers
   WHERE spbpers_pidm = p_spbpers_pidm;

 BEGIN

  p_spbpers_name_prefix := NULL;

  OPEN c21;
  FETCH c21
   INTO p_spbpers_name_prefix;
  CLOSE c21;

 END get_spbpers_name_prefix;

/*----------------------------------------------------------------------------*/
/* Update a record in the "SVRTREQ" table.                                    */
/*----------------------------------------------------------------------------*/

 PROCEDURE update_svrtreq_record
 (p_svrtreq_bgn02                 IN  VARCHAR2,
  p_svrtreq_send_date             IN  DATE,
  p_svrtreq_state_ind             IN  VARCHAR2,
  p_svrtreq_match_ind             IN  VARCHAR2,
  p_svrtreq_hold_ind              IN  VARCHAR2,
  p_svrtreq_date_ind              IN  VARCHAR2,
  p_svrtreq_completion_ind        IN  VARCHAR2,
  p_svrtreq_id                    IN  VARCHAR2,
  p_svrtreq_seq_no                IN  NUMBER,
  p_svrtreq_reason_cde            IN  VARCHAR2) IS

 BEGIN

  UPDATE svrtreq
     SET svrtreq_send_date      = NVL(p_svrtreq_send_date,     svrtreq_send_date),
         svrtreq_state_ind      = NVL(p_svrtreq_state_ind,     svrtreq_state_ind),
         svrtreq_match_ind      = NVL(p_svrtreq_match_ind,     svrtreq_match_ind),
         svrtreq_hold_ind       = NVL(p_svrtreq_hold_ind,      svrtreq_hold_ind),
         svrtreq_date_ind       = NVL(p_svrtreq_date_ind,      svrtreq_date_ind),
         svrtreq_completion_ind = NVL(p_svrtreq_completion_ind,svrtreq_completion_ind),
         svrtreq_id             = NVL(p_svrtreq_id,            svrtreq_id),
         svrtreq_seq_no         = NVL(p_svrtreq_seq_no,        svrtreq_seq_no),
         svrtreq_reason_cde     = p_svrtreq_reason_cde,
         svrtreq_activity_date  = TRUNC(SYSDATE)
   WHERE svrtreq_bgn02          = p_svrtreq_bgn02;

 END update_svrtreq_record;

END svptreq_pkg;
/
SHOW ERRORS